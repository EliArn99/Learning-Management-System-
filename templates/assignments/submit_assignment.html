{% extends 'base.html' %}
{% load static %}

{% block title %}Подаване на задание: {{ assignment.title }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #6366f1;
        --primary-light: #a5b4fc;
        --primary-dark: #4f46e5;
        --secondary-color: #8b5cf6;
        --accent-color: #ec4899;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --dark-color: #1e293b;
        --darker-color: #0f172a;
        --light-color: #f8fafc;
        --lighter-color: #ffffff;
        --gray-color: #94a3b8;
        --border-radius: 12px;
        --box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .assignment-submission-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }

    .submission-header {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border-radius: var(--border-radius);
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: var(--box-shadow);
        position: relative;
        overflow: hidden;
    }

    .submission-header::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-10px) rotate(180deg); }
    }

    .header-content {
        position: relative;
        z-index: 2;
    }

    .assignment-title {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .assignment-title i {
        font-size: 28px;
        opacity: 0.9;
    }

    .assignment-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-top: 25px;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        backdrop-filter: blur(10px);
    }

    .meta-item i {
        font-size: 18px;
        opacity: 0.9;
        width: 20px;
        text-align: center;
    }

    .meta-label {
        font-size: 12px;
        opacity: 0.8;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .meta-value {
        font-weight: 600;
        font-size: 14px;
    }

    .submission-card {
        background: var(--lighter-color);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        margin-bottom: 30px;
    }

    .card-header {
        background: linear-gradient(135deg, var(--dark-color), var(--darker-color));
        color: white;
        padding: 20px 30px;
    }

    .card-header h3 {
        margin: 0;
        font-size: 20px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-content {
        padding: 30px;
    }

    .upload-area {
        border: 2px dashed #cbd5e1;
        border-radius: var(--border-radius);
        padding: 40px 20px;
        text-align: center;
        transition: var(--transition);
        background: #f8fafc;
        cursor: pointer;
        position: relative;
    }

    .upload-area:hover {
        border-color: var(--primary-color);
        background: #f1f5f9;
    }

    .upload-area.dragover {
        border-color: var(--primary-color);
        background: rgba(99, 102, 241, 0.05);
        transform: scale(1.02);
    }

    .upload-icon {
        font-size: 48px;
        color: var(--primary-color);
        margin-bottom: 15px;
    }

    .upload-text h4 {
        margin: 0 0 8px 0;
        color: var(--dark-color);
        font-weight: 600;
    }

    .upload-text p {
        margin: 0;
        color: var(--gray-color);
        font-size: 14px;
    }

    .file-input {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        cursor: pointer;
    }

    .file-preview {
        margin-top: 20px;
        padding: 20px;
        background: #f8fafc;
        border-radius: var(--border-radius);
        border: 1px solid #e2e8f0;
        display: none;
    }

    .file-preview.active {
        display: block;
        animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-10px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .file-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .file-icon {
        width: 48px;
        height: 48px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        flex-shrink: 0;
    }

    .file-details {
        flex: 1;
    }

    .file-name {
        font-weight: 600;
        margin-bottom: 4px;
        color: var(--dark-color);
    }

    .file-size {
        font-size: 12px;
        color: var(--gray-color);
    }

    .file-remove {
        background: none;
        border: none;
        color: var(--danger-color);
        cursor: pointer;
        padding: 8px;
        border-radius: 6px;
        transition: var(--transition);
    }

    .file-remove:hover {
        background: rgba(239, 68, 68, 0.1);
    }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        align-items: center;
        margin-top: 30px;
        padding-top: 25px;
        border-top: 1px solid #e2e8f0;
        flex-wrap: wrap;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: var(--border-radius);
        font-weight: 500;
        text-decoration: none;
        transition: var(--transition);
        border: none;
        cursor: pointer;
        font-size: 15px;
    }

    .btn-primary {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 4px 6px rgba(99, 102, 241, 0.2);
    }

    .btn-primary:hover {
        background: var(--primary-dark);
        transform: translateY(-2px);
        box-shadow: 0 10px 15px rgba(99, 102, 241, 0.3);
    }

    .btn-secondary {
        background: #f1f5f9;
        color: var(--dark-color);
        border: 1px solid #cbd5e1;
    }

    .btn-secondary:hover {
        background: #e2e8f0;
        transform: translateY(-2px);
    }

    .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none !important;
    }

    .current-submission {
        background: var(--lighter-color);
        border-radius: var(--border-radius);
        box-shadow: var(--box-shadow);
        overflow: hidden;
        margin-top: 30px;
    }

    .submission-header-success {
        background: linear-gradient(135deg, var(--success-color), #3b82f6);
        color: white;
        padding: 20px 30px;
    }

    .submission-details {
        padding: 25px;
    }

    .submission-info {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .info-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 8px;
    }

    .info-item i {
        color: var(--primary-color);
        font-size: 16px;
        width: 20px;
        text-align: center;
    }

    .file-download-card {
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 20px;
        background: #f8fafc;
        border-radius: var(--border-radius);
        border: 1px solid #e2e8f0;
        transition: var(--transition);
    }

    .file-download-card:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: var(--box-shadow);
    }

    .download-icon {
        width: 50px;
        height: 50px;
        border-radius: 8px;
        background: linear-gradient(135deg, var(--success-color), #3b82f6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
        flex-shrink: 0;
    }

    .download-info {
        flex: 1;
    }

    .download-info .file-name {
        font-weight: 600;
        margin-bottom: 4px;
    }

    .download-info .file-meta {
        font-size: 12px;
        color: var(--gray-color);
    }

    .download-btn {
        background: var(--success-color);
        color: white;
        padding: 10px 20px;
        border-radius: var(--border-radius);
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: var(--transition);
    }

    .download-btn:hover {
        background: #059669;
        transform: translateY(-2px);
        color: white;
    }

    .no-submission {
        text-align: center;
        padding: 40px 20px;
        color: var(--gray-color);
    }

    .no-submission i {
        font-size: 48px;
        margin-bottom: 15px;
        opacity: 0.5;
    }

    .no-submission h4 {
        margin: 0 0 8px 0;
        color: var(--dark-color);
    }

    /* Progress bar */
    .upload-progress {
        margin-top: 15px;
        display: none;
    }

    .progress-bar {
        width: 100%;
        height: 6px;
        background: #e2e8f0;
        border-radius: 3px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        border-radius: 3px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-text {
        text-align: center;
        font-size: 12px;
        color: var(--gray-color);
        margin-top: 5px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .assignment-submission-container {
            padding: 15px;
        }

        .submission-header {
            padding: 20px;
        }

        .assignment-title {
            font-size: 24px;
        }

        .assignment-meta {
            grid-template-columns: 1fr;
        }

        .card-content {
            padding: 20px;
        }

        .form-actions {
            flex-direction: column;
            align-items: stretch;
        }

        .btn {
            width: 100%;
            justify-content: center;
        }

        .file-download-card {
            flex-direction: column;
            text-align: center;
            gap: 12px;
        }
    }

    @media (max-width: 480px) {
        .submission-header {
            padding: 15px;
        }

        .assignment-title {
            font-size: 20px;
            flex-direction: column;
            gap: 8px;
            text-align: center;
        }

        .card-content {
            padding: 15px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="assignment-submission-container">
    <!-- Header Section -->
    <div class="submission-header">
        <div class="header-content">
            <h1 class="assignment-title">
                <i class="fas fa-file-upload"></i>
                Подаване на задание
            </h1>
            <p class="text-white opacity-90">{{ assignment.title }}</p>

            <div class="assignment-meta">
                <div class="meta-item">
                    <i class="fas fa-calendar-alt"></i>
                    <div>
                        <div class="meta-label">Краен срок</div>
                        <div class="meta-value">{{ assignment.due_date|date:"d.m.Y H:i" }}</div>
                    </div>
                </div>
                <div class="meta-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <div class="meta-label">Оставащо време</div>
                        <div class="meta-value" id="timeRemaining">
                            {% if assignment.is_past_due %}
                                <span style="color: var(--danger-color);">Изтекъл срок</span>
                            {% else %}
                                {{ assignment.due_date|timeuntil }}
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="meta-item">
                    <i class="fas fa-file-alt"></i>
                    <div>
                        <div class="meta-label">Тип задание</div>
                        <div class="meta-value">Файлово подаване</div>
                    </div>
                </div>
                <div class="meta-item">
                    <i class="fas fa-info-circle"></i>
                    <div>
                        <div class="meta-label">Статус</div>
                        <div class="meta-value">
                            {% if submission %}
                                <span style="color: var(--success-color);">Подадено</span>
                            {% else %}
                                <span style="color: var(--warning-color);">Неподадено</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Submission Form Card -->
    <div class="submission-card">
        <div class="card-header">
            <h3><i class="fas fa-upload"></i> Качване на решение</h3>
        </div>
        <div class="card-content">
            <form method="post" enctype="multipart/form-data" id="submissionForm">
                {% csrf_token %}

                <!-- File Upload Area -->
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <div class="upload-text">
                        <h4>Кликнете или пуснете файл тук</h4>
                        <p>PDF, DOC, DOCX, ZIP до 25MB</p>
                    </div>
                    <input type="file" name="file" id="fileInput" class="file-input" accept=".pdf,.doc,.docx,.zip,.rar" required>
                </div>

                <!-- File Preview -->
                <div class="file-preview" id="filePreview">
                    <div class="file-info">
                        <div class="file-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name" id="fileName">Файлът ще се покаже тук</div>
                            <div class="file-size" id="fileSize">-</div>
                        </div>
                        <button type="button" class="file-remove" id="removeFile">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- Upload Progress -->
                <div class="upload-progress" id="uploadProgress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">0% качено</div>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                {# TODO: FIX HERE #}
{#                    <a href="{% url 'course_detail' assignment.course.id %}" class="btn btn-secondary">#}
{#                        <i class="fas fa-arrow-left"></i>#}
{#                        Назад към курса#}
{#                    </a>#}
                    <button type="submit" class="btn btn-primary" id="submitBtn" {% if assignment.is_past_due %}disabled{% endif %}>
                        <i class="fas fa-paper-plane"></i>
                        {% if assignment.is_past_due %}
                            Изтекъл срок
                        {% else %}
                            Подай задание
                        {% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Current Submission Card -->
    {% if submission %}
    <div class="current-submission">
        <div class="submission-header-success">
            <h3><i class="fas fa-check-circle"></i> Текущо подаване</h3>
        </div>
        <div class="submission-details">
            <div class="submission-info">
                <div class="info-item">
                    <i class="fas fa-calendar-check"></i>
                    <div>
                        <div class="meta-label">Дата на подаване</div>
                        <div class="meta-value">{{ submission.submitted_at|date:"d.m.Y H:i" }}</div>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-clock"></i>
                    <div>
                        <div class="meta-label">Подадено преди</div>
                        <div class="meta-value">{{ submission.submitted_at|timesince:assignment.due_date }} преди крайния срок</div>
                    </div>
                </div>
                <div class="info-item">
                    <i class="fas fa-sync-alt"></i>
                    <div>
                        <div class="meta-label">Статус на оценяване</div>
                        <div class="meta-value">
                            {% if submission.is_graded %}
                                <span style="color: var(--success-color);">Оценено</span>
                            {% else %}
                                <span style="color: var(--warning-color);">Чака оценка</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            {% if submission.file %}
            <div class="file-download-card">
                <div class="download-icon">
                    <i class="fas fa-file-download"></i>
                </div>
                <div class="download-info">
                    <div class="file-name">{{ submission.file.name|slice:"13:" }}</div>
                    <div class="file-meta">Подаден на {{ submission.submitted_at|date:"d.m.Y H:i" }}</div>
                </div>
                <a href="{{ submission.file.url }}" class="download-btn" download>
                    <i class="fas fa-download"></i>
                    Изтегли
                </a>
            </div>
            {% else %}
            <div class="no-submission">
                <i class="fas fa-exclamation-triangle"></i>
                <h4>Няма прикачен файл</h4>
                <p>Моля, подайте заданието отново с прикачен файл.</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const filePreview = document.getElementById('filePreview');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFile = document.getElementById('removeFile');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressText');
        const submitBtn = document.getElementById('submitBtn');
        const submissionForm = document.getElementById('submissionForm');

        // File upload handling
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('click', () => fileInput.click());
        removeFile.addEventListener('click', clearFileSelection);

        // Drag and drop functionality
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, () => uploadArea.classList.remove('dragover'), false);
        });

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            handleFileSelect();
        }

        function handleFileSelect() {
            const file = fileInput.files[0];
            if (file) {
                const isValidType = validateFileType(file);
                const isValidSize = validateFileSize(file);

                if (isValidType && isValidSize) {
                    showFilePreview(file);
                    submitBtn.disabled = false;
                } else {
                    clearFileSelection();
                    if (!isValidType) {
                        alert('Моля, изберете валиден файлов формат (PDF, DOC, DOCX, ZIP, RAR).');
                    } else {
                        alert('Файлът е твърде голям. Максималният размер е 25MB.');
                    }
                }
            }
        }

        function validateFileType(file) {
            const allowedTypes = [
                'application/pdf',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                'application/zip',
                'application/x-rar-compressed'
            ];
            return allowedTypes.includes(file.type);
        }

        function validateFileSize(file) {
            const maxSize = 25 * 1024 * 1024; // 25MB in bytes
            return file.size <= maxSize;
        }

        function showFilePreview(file) {
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.classList.add('active');
        }

        function clearFileSelection() {
            fileInput.value = '';
            filePreview.classList.remove('active');
            submitBtn.disabled = true;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Form submission with progress simulation
        submissionForm.addEventListener('submit', function(e) {
            if (!fileInput.files[0]) {
                e.preventDefault();
                alert('Моля, изберете файл преди подаване.');
                return;
            }

            // Show progress bar
            uploadProgress.style.display = 'block';
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Качване...';

            // Simulate upload progress
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 10;
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(interval);
                }
                progressFill.style.width = progress + '%';
                progressText.textContent = Math.round(progress) + '% качено';
            }, 200);

            // Allow form submission to proceed
            // In a real application, you would use AJAX for actual progress tracking
        });

        // Update time remaining
        function updateTimeRemaining() {
            const timeRemaining = document.getElementById('timeRemaining');
            if (timeRemaining) {
                // This would need server-side time calculation for accuracy
                // For demo purposes, we'll just update the text
                console.log('Updating time remaining...');
            }
        }

        // Update time every minute
        setInterval(updateTimeRemaining, 60000);

        // Add keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 'Enter' && !submitBtn.disabled) {
                    e.preventDefault();
                    submissionForm.submit();
                }
            }
        });
    });
</script>
{% endblock %}
